/**********************************************************************
 * 📎  QUICK-FIX FOR MISSING /editorBridge.js                          *
 *                                                                    *
 * 1. Serves the file from /public or /static if it exists.           *
 * 2. Emits a literal bridge stub if the real file is missing.        *
 * 3. Adds CORS + cache headers so the browser never gets a 403.      *
 *********************************************************************/

const express = require("express");
const path     = require("path");
const fs       = require("fs");
const app      = module.exports = require("./server");   // ← hook into your
                                                         //    existing Express
// -------- 1. normal static serving (preferred path)  -----------------
app.use(express.static(path.join(__dirname, "public"), {
  index: false,
  fallthrough: true        // important – keep going if file not there
}));

// -------- 2. explicit route as a safety-net  -------------------------
app.get("/editorBridge.js", (req, res, next) => {
  const bridgePath = [
    path.join(__dirname, "public",  "editorBridge.js"),
    path.join(__dirname, "static",  "editorBridge.js"),
    path.join(__dirname, "bridge",  "editorBridge.js")
  ].find(p => fs.existsSync(p));

  // 2a) Found the real file –> stream it with friendly headers
  if (bridgePath) {
    res.set({
      "Content-Type"  : "application/javascript; charset=utf-8",
      "Cache-Control" : "public,max-age=604800",          // 1 week
      "Access-Control-Allow-Origin": "*"
    });
    return res.sendFile(bridgePath);
  }

  // 2b) File *still* missing –> ship a tiny stub so the UI doesn’t crash
  console.warn("⚠️  /editorBridge.js not found – serving stub.");
  res.type("js").send(`
    // Lightweight fallback so the preview keeps working.
    console.info("🛈 editorBridge stub injected – real file missing.");
    window.__editorBridge__ = {
      version    : "stub",
      isReady    : () => false,
      openPanel  : () => alert("Inline editor unavailable – missing bridge")
    };
    export default window.__editorBridge__;
  `);
});

// -------- 3. log a pointer so future you remembers why this is here --
console.log("✅  Protective route for /editorBridge.js is active.");