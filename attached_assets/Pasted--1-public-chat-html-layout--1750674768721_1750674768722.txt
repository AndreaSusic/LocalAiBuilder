# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1 â–¸ public/chat.html â€” layout & IDs
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"><title>GoAiSite â€“ Builder Chat</title>
<link rel="stylesheet" href="/styles.css">
</head><body>

<!--  A .chatPane now holds: label â–¸ thread â–¸ input  -->
<div id="chatPane">
  <p id="introLabel">
    Hi! I will help you create your website. Tell me about your business and
    what you would like your site to include.
  </p>

  <div id="chatThread"></div>

  <div id="chatFooter">
    <label class="file-btn">ðŸ“Ž
      <input type="file" id="fileInput" accept="image/*" multiple hidden>
    </label>
    <div id="chatInput" contenteditable="true"
         data-placeholder="Describe your businessâ€¦"></div>
    <button id="sendBtn">âž¤</button>
  </div>
</div>

<script src="/chat.js"></script>  <!-- keep at end, no defer -->
</body></html>

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2 â–¸ public/styles.css â€” chat on right, placeholder, heights
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/* right-column pane on HP */
.chatPane, #chatPane{display:flex;flex-direction:column;height:100%;}

/* intro label */
#introLabel{font-weight:600;margin:0 0 .8rem .2rem;}

/* chat thread grows but never pushes footer below fold */
#chatThread{flex:1;overflow-y:auto;padding:1rem;background:#f9f9f9;}

/* placeholder for contenteditable */
#chatInput:empty:before{
  content:attr(data-placeholder);
  color:#999;
}

#chatInput{flex:1;min-height:42px;max-height:160px;overflow-y:auto;
           padding:.5rem;border:1px solid #ccc;border-radius:6px;}

#chatFooter{display:flex;align-items:center;gap:.5rem;padding:.6rem;
            border-top:1px solid #eee;}

#sendBtn{background:#0050c8;color:#fff;border:none;padding:.6rem 1rem;
         border-radius:6px;cursor:pointer;}

.file-btn{cursor:pointer;}

#thumbs img{width:60px;height:60px;object-fit:cover;margin:4px;border-radius:4px;}

.hidden{display:none!important;}

#chatContainer iframe.chatPane{height:90vh;border:1px solid #ddd;border-radius:8px;}

#chatContainer{display:flex;gap:2rem;align-items:flex-start;}
.hero{flex:1 0 55%;}
.chatPaneWrapper{flex:1 0 45%;}

@media(max-width:900px){
  #chatContainer{flex-direction:column;}
  #chatContainer iframe.chatPane{height:75vh;}
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3 â–¸ public/chat.js â€” robust send + soft regex + no repeat
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = id => document.getElementById(id);
const thread=$('chatThread'), input=$('chatInput'),
      send=$('sendBtn'), files=$('fileInput');

const RX_COMP = /([A-Z][\w-]+\s+[A-Z][\w-]+)/;   // "My Tooth"
const RX_INDS = /(dental|plumb|lawn|roof|legal|marketing|shoe|retail)/i;

let convo=[], state={company_name:null,city:null,industry:null,
                     language:null,services:null}, images=[],
    turns=0, MAX_FREE=15;

/* bubble helper */
function bubble(role,txt){ const d=document.createElement('div');
  d.className=`bubble ${role==='user'?'user':'ai'}`; d.textContent=txt;
  thread.appendChild(d); thread.scrollTop=thread.scrollHeight; }

/* local regex fallback */
function softFill(text){
  if(!state.company_name){
    const m=text.match(RX_COMP); if(m) state.company_name=m[1];
  }
  if(!state.industry){
    const m=text.match(RX_INDS); if(m) state.industry=guessIndustry(m[1]);
  }
}
function guessIndustry(word){
  const map={dental:'Dental',plumb:'Plumbing',lawn:'Landscaping',
             roof:'Roofing',legal:'Legal',marketing:'Advertising & Marketing',
             shoe:'Shoes & Apparel',retail:'Retail'};
  for(const k in map) if(word.toLowerCase().includes(k)) return map[k];
  return null;
}

/* send logic */
async function sendUser(){
  const text=input.innerText.trim();
  if(!text && !files.files.length) return;

  if(text) bubble('user',text);        // preview
  if(files.files.length) bubble('user','ðŸ“· image attached');

  softFill(text);                      // local parse
  convo.push({role:'user',content:text});
  images.push(...files.files); files.value=''; input.textContent='';

  if(++turns>MAX_FREE){ paywall(); return; }

  const fd=new FormData();
  fd.append('prompt',JSON.stringify(convo));
  images.forEach(f=>fd.append('images',f));

  const res = await fetch('/api/analyse',{method:'POST',body:fd});
  const j   = await res.json();
  mergeState(j); handleMissing(j);
}
function mergeState(obj){
  ['company_name','city','industry','language','services'].forEach(k=>{
    if(obj[k]) state[k]=obj[k];
  });
}
function handleMissing(r){
  let miss = r.missing_fields || [];
  miss = miss.filter(k=>state[k]===null);     // drop any we just filled
  if(!miss.length){ bubble('ai','Great! Generating your siteâ€¦'); return; }

  const key = miss[0];
  const Q = {
    company_name:'Whatâ€™s the name of your business?',
    city:'Which city do you mainly serve?',
    industry:'What industry best describes your business?',
    language:'What primary language should the website use?',
    services:'List your most important services or products.'
  }[key] || `Please provide your ${key}.`;

  const lastAI = convo.filter(m=>m.role==='assistant').pop()?.content;
  if(lastAI!==Q){ bubble('ai',Q); convo.push({role:'assistant',content:Q}); }
}
function paywall(){
  bubble('ai','Free limit reached â€“ <a href="/pricing">upgrade to Pro</a>.');
  $('chatFooter').style.display='none';
}

/* events */
send.onclick = sendUser;
input.addEventListener('keydown',e=>{
  if(e.key==='Enter' && !e.shiftKey){e.preventDefault(); sendUser();}
});
files.onchange = ()=>{ if(files.files.length) bubble('user','ðŸ“· image attached'); };

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# RESULT
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Intro label restored above the chat.  
â€¢ Chat thread & input sit directly below the label (no big gap).  
â€¢ Message **sends correctly** (IDs now match; script loads after DOM).  
â€¢ Chat pane still docks on the right column of your HP; flex-box collapses
  to a single column on mobile.  
â€¢ Free-tier 15-turn limit, image uploads, industry taxonomy, and no-repeat
  questions all remain intact.