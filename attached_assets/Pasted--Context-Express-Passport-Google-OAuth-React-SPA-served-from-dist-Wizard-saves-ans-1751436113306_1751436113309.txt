

Context
=======
â€¢ Express + Passport-Google OAuth
â€¢ React SPA served from /dist
â€¢ Wizard saves answers in `state`
â€¢ After OAuth callback we get â€œreturnTo: undefinedâ€ â†’ blank page.

We need to:
1. Preserve â€œwhere to go backâ€ (`returnTo`) when we start OAuth.
2. Preserve the anonymous draft (wizard answers) and attach it to the Google-user row.
3. Make sure the session cookie survives callback.
4. Redirect back to /preview (or /dashboard) with real bootstrap.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
STEP 1 â€“ session middleware hardening
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”¸ **server/index.js**  (top)

```js
import session from 'express-session';

app.use(
  session({
    secret: process.env.SESSION_SECRET,
    resave: false,
    saveUninitialized: false,
    cookie: {
      secure: true,   // Replit HTTPS proxy
      sameSite: 'lax'
    }
  })
);

If you run locally, override cookie.secure = false when
NODE_ENV !== 'production'.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
STEP 2 â€“ start-auth route captures returnTo
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”¸ routes/auth.js (or in server file)

app.get('/auth/google',
-  passport.authenticate('google', { scope:['profile','email'] })
+  (req, res, next) => {
+    // remember path to come back to
+    req.session.returnTo =
+      req.query.returnTo || req.headers.referer || '/dashboard';
+    next();
+  },
+  passport.authenticate('google', { scope:['profile','email'] })
);

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
STEP 3 â€“ client-side redirect always passes returnTo
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”¸ src/chat.js (login button handler)

// save draft before leaving
sessionStorage.setItem('draft', JSON.stringify(state));

// build clean OAuth URL
const back = encodeURIComponent(location.pathname + location.search);
window.location.href = `/auth/google?returnTo=${back}`;

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
STEP 4 â€“ callback migrates draft + redirects
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”¸ routes/auth.js (callback)

app.get('/auth/google/callback',
  passport.authenticate('google', { failureRedirect: '/login' }),
- (req, res) => res.redirect('/dashboard')
+ async (req, res) => {
+   /* 1â€Šâ€“â€Šmigrate wizard draft */
+   if (req.session.draft) {
+     await db.put(req.user.id, JSON.parse(req.session.draft));
+     delete req.session.draft;
+   }
+
+   /* 2â€Šâ€“â€Šgo back where we came from */
+   const go = req.session.returnTo || '/dashboard';
+   delete req.session.returnTo;
+   res.redirect(go);
+ }
);

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
STEP 5 â€“ React bootstrap fallback
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”¸ src/main.jsx

async function loadBootstrap() {
  /* primary: secure API */
  const api = await fetch('/api/user-data');
  if (api.status !== 401) {
    const { bootstrap } = await api.json();
    return bootstrap;
  }

  /* fallback: ?data= or sessionStorage */
  const p = new URLSearchParams(location.search);
  if (p.has('data')) {
    return JSON.parse(decodeURIComponent(p.get('data')));
  }
  const draft = sessionStorage.getItem('draft');
  return draft ? JSON.parse(draft) : {};
}

loadBootstrap().then(bootstrap => {
  ReactDOM.createRoot(document.getElementById('root'))
    .render(<App bootstrap={bootstrap} />);
});

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
After applying:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
	1.	Wizard â†’ â€œLogin with Googleâ€ fires /auth/google?returnTo=/previewâ€¦
	2.	Callback finds returnTo, migrates draft, redirects to /preview.
	3.	React logs real bootstrap â†’ white screen gone.

---

**What to do**

1. Paste the prompt above into Ghostwriter.  
2. Accept the code diffs it generates.  
3. Add the callback URI to Google Cloud console:  
   `https://<your-repl>.repl.co/auth/google/callback`  
4. Click **Run**, go through the wizard, hit **Login**, and you should land back on `/preview` with your customized homepage instead of a white screen.